({extendsFrom:'BaseView',rule:{},ruleIndex:'',e38_fields:{},e38_ModuleBean:null,operationLabels:{$equals_value:'LBL_OPERATOR_EQUALS_VALUE',$equals:'LBL_OPERATOR_EQUALS',$not_equals:'LBL_OPERATOR_NOT_EQUALS',$lt:'LBL_OPERATOR_LESS_THAN',$lte:'LBL_OPERATOR_LESS_THAN_OR_EQUALS',$gt:'LBL_OPERATOR_GREATER_THAN',$gte:'LBL_OPERATOR_GREATER_THAN_OR_EQUALS',$starts:'LBL_OPERATOR_STARTS_WITH',$ends:'LBL_OPERATOR_ENDS_WITH',$contains:'LBL_OPERATOR_CONTAINS',$fuzzy_match:'LBL_OPERATOR_FUZZY',},operationsFields:{$equals_value:{renderField:!0,fieldType:'selectedField',},$equals:{renderField:!1},$fuzzy_match:{renderField:!1},$not_equals:{renderField:!1},$starts:{renderField:!0,fieldType:'text'},$ends:{renderField:!0,fieldType:'text'},$contains:{renderField:!0,fieldType:'text'},$lt:{renderField:!0,fieldType:'datetimecombo'},$lte:{renderField:!0,fieldType:'datetimecombo'},$gt:{renderField:!0,fieldType:'datetimecombo'},$gte:{renderField:!0,fieldType:'datetimecombo'},},restrictedFieldTypes:['tag','link','id','teamset','fullname','image'],restrictedEmailFields:['emails','email1','email2','invalid_email','email_opt_out','email_addresses_primary','email_addresses','email_addresses_non_primary'],initialize:function(options){this.rule={};this.ruleIndex='';this.e38_fields={};this.ruleIndex=options.meta.ruleIndex;this.rule=options.meta.rule;this.e38_ModuleBean=app.data.createBean(this.rule.for_module,{});this._super('initialize',[options]);var rule=$('<div>',{'class':'row-fluid rule-row','data-rule-id':this.ruleIndex});this.setElement(rule);},render:function(){this._super('render');this.renderInitialFields();},availableOperations:function(field_type){var available_operators=[];switch(field_type){case'enum':case'date':case'datetime':case'bool':case'int':case'currency':case'email':case'relate':available_operators=['$equals'];break;case'phone':case'varchar':case'name':case'fullname':case'assigned_user_name':case'text':available_operators=['$equals','$fuzzy_match'];break;default:available_operators=['$equals'];}
return available_operators;},getOperationsWithLabels:function(a){var b=this;a=b.availableOperations(a);var c={};$.each(a,function(a,d){c[d]=app.lang.get(b.operationLabels[d],'E38_DuplicateFinderProcess');});return c;},getFieldsWithLabels:function(){var a=this,b=app.data.createBean(a.rule.for_module,{}),c={};b.fields['email']={name:'email',vname:'LBL_EMAIL_ADDRESS'};$.each(b.fields,function(b,d){if(-1==$.inArray(d.type,a.restrictedFieldTypes)&&'id'!==d.dbType){if(-1!=$.inArray(d.name,a.restrictedEmailFields))
return!0;var field_label=app.lang.get(d.vname,a.rule.for_module);if(typeof d.name=='undefined'||typeof field_label=='undefined'){return!0;}
var field_name=field_label+' ('+d.name+')';if(typeof field_name!='undefined'){c[b]=field_name;}}});return c;},renderInitialFields:function(){var a=this;_.isEmpty(this.rule)||$.each(a.rule,function(b,c){var f=app.data.createBean(a.rule.for_module,{});var d;d='object'!=typeof a.rule.e38_field?''!==a.rule.e38_field?f.fields[a.rule.e38_field].type:null:''!==a.rule.e38_field?f.fields[a.rule.e38_field.fieldName].type:null;switch(b){case'for_module':var e='for_module';a.e38_ModuleBean.set(e,c);var g={},f=app.metadata.getModuleNames({filter:['enabled','visible','display_tab']});$.each(f,function(a,b){_.contains(['Home','Calendar','Reports','Emails'],b)||(g[b]=app.lang.getModuleName(b,{plural:!0}));});a.createField('module','enum',e,'LBL_E38_MODEL',g);a.e38_fields.module.setDisabled();break;case'e38_field':e='e38_field_'+a.ruleIndex;if('object'==typeof a.rule.e38_field){a.e38_ModuleBean.set(e,c.fieldName);}else{a.e38_ModuleBean.set(e,c);}
a.e38_ModuleBean.on('change:'+e,a.fieldValueChanged,a);a.createField('field','enum',e,'LBL_E38_FIELD',a.getFieldsWithLabels());break;case'e38_operation':e='e38_operation_'+a.ruleIndex;a.e38_ModuleBean.set(e,c);a.e38_ModuleBean.on('change:'+e,a.operationValueChanged,a);g=null!=d?a.getOperationsWithLabels(d):{'':''};a.createField('operation','enum',e,'LBL_E38_OPERATION',g);null==d&&a.e38_fields.operation.setDisabled();break;case'e38_value':''!=a.rule.e38_operation&&1==a.operationsFields[a.rule.e38_operation].renderField&&('selectedField'==a.operationsFields[a.rule.e38_operation].fieldType?('object'==typeof a.rule.e38_field?(e=a.rule.e38_field.fieldName,a.e38_ModuleBean.set(e,c.valueName),a.e38_ModuleBean.set(a.rule.e38_field.fieldId,c.valueId)):(e=a.rule.e38_field,a.e38_ModuleBean.set(e,c)),d=null!==d?d:'text','enum'==d?a.createField('value',d,e,'LBL_E38_VALUE',f.fields[a.rule.e38_field].options):a.createField('value',d,e,'LBL_E38_VALUE')):(d=a.operationsFields[a.rule.e38_operation].fieldType,e=a.rule.e38_field,a.e38_ModuleBean.set(e,c),a.createField('value',d,e,'LBL_E38_VALUE')));}});},createField:function(a,b,c,f,d){b='enum'==b?app.view.createField({view:this,model:this.e38_ModuleBean,def:{type:b,name:c,label:f,options:d},}):app.view.createField({view:this,model:this.e38_ModuleBean,def:{type:'datetime'==b?'datetimecombo':b,name:c,label:f},});this.$('.rule-'+a).html(b.$el);b.setMode('edit');b.render();this.e38_fields[a]=b;},fieldValueChanged:function(a){a=a.changed[Object.keys(a.changed)[0]];a=this.getOperationsWithLabels(this.e38_ModuleBean.fields[a].type);this.e38_fields.operation.items=a;this.e38_ModuleBean.set('e38_operation_'+this.ruleIndex,'');this.e38_fields.operation.setDisabled(!1);this.e38_fields.operation.render();null!=this.e38_fields.value&&(this.e38_fields.value.remove(),delete this.e38_fields.value);},operationValueChanged:function(a){var b=this.e38_ModuleBean.get('e38_operation_'+this.ruleIndex);if(''!=b){a=this.e38_ModuleBean.get('e38_field_'+this.ruleIndex),this.e38_ModuleBean.set(a,''),1==this.operationsFields[b].renderField?('selectedField'==this.operationsFields[b].fieldType?(b=this.e38_ModuleBean.fields[this.e38_ModuleBean.get('e38_field_'+this.ruleIndex)].type,'enum'==b?this.createField('value',b,a,'LBL_E38_VALUE',this.e38_ModuleBean.fields[a].options):this.createField('value',b,a,'LBL_E38_VALUE')):(b=this.operationsFields[b].fieldType,this.createField('value',b,a,'LBL_E38_VALUE')),this.e38_fields.value.render()):null!=this.e38_fields.value&&(this.e38_fields.value.remove(),delete this.e38_fields.value);}},getRuleValues:function(){var a=this.e38_ModuleBean.get('e38_field_'+this.ruleIndex),b=this.e38_ModuleBean.get('e38_operation_'+this.ruleIndex);this.e38_ModuleBean.get('for_module');var c=this.e38_ModuleBean.get(a);if(''==a||'undefined'==typeof a||''==b||'undefined'==typeof b)return this.$el.addClass('rule-invalid'),!1;if(1==this.operationsFields[b].renderField){if(!0===this.e38_fields.value.model.fields[a].hasOwnProperty('id_name')&&(a=this.e38_fields.value.model.fields[a].id_name,c=this.e38_fields.value.model.get(a)),''==c||'undefined'==typeof c||''==a||'undefined'==typeof a)return this.$el.addClass('rule-invalid'),!1;}else c='$'+a;this.$el.addClass('rule-valid');var f={};f[a]={};f[a][b]=c;return f;},});