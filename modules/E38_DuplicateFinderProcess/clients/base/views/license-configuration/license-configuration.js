({licensed_module:'E38_DeDupit',extendsFrom:'BaseView',events:{'click #update-license':'validateAndStoreLicense','click #closeConfiguration':'closeConfiguration','click .activate-user':'activateUser','click .deactivate-user':'deActivateUser','click #save_configuration':'saveConfiguration',},per_user:false,licenses_count:0,license:'',license_valid:false,show_loader:false,users:{},initialize:function(options){this._super('initialize',[options]);this.users_list=app.template.get('license-configuration.users-list.'+this.licensed_module);Handlebars.registerPartial('users-list',this.users_list);},loadData:function(){var self=this;this.show_loader=true;this.retrieveLicense().then(function(response){self.show_loader=false;self.render();});},retrieveLicense:function(){return new Promise(function(resolve,reject){app.api.call('read',app.api.buildURL(this.licensed_module+'/get-license-data'),null,{success:function(response){if(response.success){this.license=response.license;this.license_valid=true;this.per_user=response.per_user;this.users=response.users;this.licenses_count=response.licenses_count;resolve(true);}else{if(response.message){app.alert.show('error',{level:'error',messages:response.message,});}
resolve(false);}}.bind(this),error:function(error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);reject();}.bind(this),});}.bind(this));},validateAndStoreLicense:function(event){var license=this.$('#license-key').val().trim();if(this.license==''&&license==''){app.alert.show('enter-license',{level:'warning',messages:'Please enter the license key before saving.',autoClose:true,});return;}
this.license=license;this.show_loader=true;this.render();var url=app.api.buildURL(this.licensed_module+'/validate-license');app.api.call('create',url,{license:this.license},{success:function(response){if(response.success){this.license_valid=true;this.per_user=response.per_user;this.users=response.users;this.licenses_count=response.licenses_count;}else{app.alert.show('license-not-valid',{level:'error',messages:response.message,autoClose:false,});}
if(response.message=='License removed.'){location.reload();}
this.show_loader=false;this.render();}.bind(this),error:function(error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);}.bind(this),});},render:function(){this._super('render');if(this.show_loader){this.$('#e38_loader').show();}else{this.$('#e38_loader').hide();}},activateUser:function(event){this.toggleUser(event,1);},deActivateUser:function(event){this.toggleUser(event,0);},toggleUser:function(event,active){var user_id=$(event.target).closest('.user-container').attr('id');var user=_.find(this.users,function(user){return user.source_id==user_id;});user.active=active;this.render();},saveConfiguration:function(){this.licenses_count=$('#licenses_count').val().trim();if(this.licenses_count==''||isNaN(this.licenses_count)){app.alert.show('not-number',{level:'error',messages:'Please enter a numeric value in "Maximum Active Users" field.',});return;}
var active_users_count=0;$.each(this.users,function(index,user_data){if(user_data.active){active_users_count++;}});if(this.licenses_count<active_users_count){app.alert.show('too-many-users',{level:'error',messages:'You have more active users than available licenses. Please increase the number of maximum active users or deactivate some of the active users.',});return;}
app.alert.dismissAll();app.alert.show('loader',{'level':'process'});var url=app.api.buildURL(this.licensed_module+'/save-configuration');var post_data={users:this.users,licenses_count:this.licenses_count,};app.api.call('create',url,post_data,{success:function(response){app.alert.dismissAll();if(response.success){app.alert.show('configuration-saved',{level:'success',messages:'Configuration has been successfully saved.',});this.license_valid=true;this.per_user=response.per_user;this.users=response.users;this.licenses_count=response.licenses_count;this.render();}else{app.alert.show('server-error',{level:'error',messages:response.message,});}}.bind(this),error:function(error){app.alert.dismissAll();if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);}.bind(this),});},closeConfiguration:function(){app.router.navigate('#bwc/index.php?module=Administration&action=index',{trigger:true});},});