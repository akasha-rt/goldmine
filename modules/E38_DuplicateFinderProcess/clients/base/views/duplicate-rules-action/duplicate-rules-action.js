({className:'duplicate-rules-action',extendsFrom:'BaseView',licenseValid:false,process_module:'',process_configuration_string:'',process_configuration:[],config_fields:[],render_fields:{},list_of_fields:[],values_to_add:[],processBean:null,processId:'',that:null,rules:{},initial_configuration:null,events:{'click a[name="cancel_button"]':'duplicateRulesCancel','click a[name="add_new_rule"]':'addRule','click .rule-remove':'removeRule','click a[name="save_button"]':'saveConfiguration',},initialize:function(options){var self=this;self.rules={};self.values_to_add=[];self.context=options.context;if(_.isUndefined(self.model)){self.model=options.context.get('model');}
self.that=options.context.get('this');if(self.model.get('id').length>0){self.process_module=this.model.get('for_module');self.process_configuration_string=this.model.get('rules_configuration');}
if(!_.isUndefined(self.process_configuration_string)&&self.process_configuration_string.length>0){self.process_configuration=JSON.parse(self.process_configuration_string);}
self.options.meta=_.extend({},app.metadata.getView(null,'duplicate-rules-action'),options.meta);self._super('initialize',[options]);self.buttons=self.options.meta.buttons;this.initial_configuration=this.model.get('rules_configuration');},duplicateRulesCancel:function(){this.values_to_add=[];app.drawer.close();},populateExistingData:function(){var self=this;self.config_fields=[];if(this.process_configuration!==''){var e38_bean=app.data.createBean(self.model.get('for_module'),{});$.each(this.process_configuration,function(config_index,configuration){self.config_fields[config_index]=[];var field=Object.keys(configuration)[0];var operation=Object.keys(configuration[field])[0];var value=configuration[field][operation];if(e38_bean.fields[Object.keys(configuration)[0]].dbType=='id'){var fieldName=e38_bean.fields[Object.keys(configuration)[0]].group;var relatedToE38Bean=app.data.createBean(e38_bean.fields[fieldName].module,{id:value});relatedToE38Bean.fetch({success:function(relatedModel){var valueName=relatedModel.get('name');var rule={for_module:self.model.get('for_module'),e38_field:{fieldId:field,fieldName:fieldName},e38_operation:operation,e38_value:{valueId:value,valueName:valueName},};self.addRuleView(Date.now(),rule);},});}else{var rule={for_module:self.model.get('for_module'),e38_field:field,e38_operation:operation,e38_value:value,};self.addRuleView(Date.now(),rule);}});}else{var rule={for_module:self.model.get('for_module'),e38_field:'',e38_operation:'',e38_value:'',};self.addRuleView(Date.now(),rule);}},loadData:function(){var self=this;self.checkLicense().then(function(response){var that=this;if(response.status){that.render();that.populateExistingData();}else{app.alert.show('invalid-license',{level:'error',messages:response.msg,autoClose:false,});}}.bind(self)).catch(function(){}.bind(self));},addRule:function(event){var rule={for_module:this.model.get('for_module'),e38_field:'',e38_operation:'',e38_value:'',};this.addRuleView(Date.now(),rule);},addRuleView:function(ruleIndex,rule){var self=this;self.rules[ruleIndex]=app.view.createView({name:'rule',meta:{rule:rule,ruleIndex:ruleIndex,},});self.$('#rules').append(self.rules[ruleIndex].$el);self.rules[ruleIndex].render();},removeRule:function(event){var ruleIndex=event.target.getAttribute('data-rule-index');this.$('[data-rule-id="'+ruleIndex+'"]').remove();delete this.rules[ruleIndex];},saveConfiguration:function(event){var self=this;if(_.isEmpty(self.rules)){return;}
var errors=false;var rules=[];$.each(this.rules,function(key,val){var ruleObj=val.getRuleValues();if(ruleObj==false){errors=true;}else{rules.push(ruleObj);}}.bind(self));if(errors){app.alert.show('configuration-saving-error',{level:'error',title:app.lang.get('LBL_CONFIGURATION_NOT_FILLED_OUT','E38_DuplicateFinderProcess'),autoClose:true,});}else{if(this.initial_configuration==''){self.preSaveProcessBean(rules);return;}
if(this.initial_configuration!=JSON.stringify(rules)){app.alert.show('confirm-rules-change',{level:'confirmation',messages:app.lang.get('LBL_CONFIRM_RULES_CHANGE','E38_DuplicateFinderProcess'),title:app.lang.get('LBL_CONFIRM_RULES_CHANGE_TITLE','E38_DuplicateFinderProcess'),autoClose:false,onConfirm:function(){self.preSaveProcessBean(rules);},onCancel:function(){self.duplicateRulesCancel();},});}}},preSaveProcessBean:function(rules){var self=this;app.alert.show('configuration-saving',{level:'process',title:app.lang.get('LBL_CONFIGURATION_IS_BEING_SAVED','E38_DuplicateFinderProcess'),});if(self.processBean===null){var bean=app.data.createBean('E38_DuplicateFinderProcess',{id:self.model.id});bean.fetch({success:function(processModel){self.processBean=processModel;self.saveProcessBean(rules);},});}else{self.saveProcessBean(rules);}},saveProcessBean:function(rules){var self=this;self.processBean.set('rules_configuration',JSON.stringify(rules));self.processBean.save({},{success:function(record){app.alert.dismiss('configuration-saving');app.alert.show('configuration-saved',{level:'success',messages:app.lang.get('LBL_CONFIGURATION_WAS_SAVED','E38_DuplicateFinderProcess'),autoClose:true,});app.drawer.close(record,self.that);},error:function(error){app.alert.dismiss('configuration-saving-bean-error');app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false,});app.error.handleHttpError(error);},});},checkLicense:function(){var self=this;return new Promise(function(resolve,reject){app.api.call('read',app.api.buildURL('E38_DeDupit/check-license'),null,{success:function(response){if(response.success){self.licenseValid=true;resolve({status:true});}else{self.licenseValid=false;resolve({status:false,msg:response.message});}},error:function(error){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoCLose:false,});app.error.handleHttpError(error);self.licenseValid=false;resolve({status:false});},});});},});