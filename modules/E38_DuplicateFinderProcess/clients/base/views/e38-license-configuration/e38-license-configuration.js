({extendsFrom:'BaseView',events:{'click #update-license':'updateLicense','click #closeConfiguration':'closeConfiguration',},module_name:'E38_DeDupit',full_module_label:'Sugar DeDupit',promises:[],license:'',usersLoaded:false,loadData:function(){var checkLicense=new Promise(this.checkLicense.bind(this));checkLicense.then(function(response){if(response){this.promises.push(new Promise(this.sendUserData.bind(this)));}
this.render();}.bind(this));Promise.all(this.promises).then(function(promiseResponse){setTimeout(function(){this.usersLoaded=true;this.render();}.bind(this),500);}.bind(this));},checkLicense:function(resolve,reject){app.api.call('read',app.api.buildURL(this.module_name+'/license'),null,{success:function(config){if(!config.error){this.license=config.license;resolve(true);}else{resolve(false);}}.bind(this),error:function(error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);reject();}.bind(this),});},sendUserData:function(resolve,reject){app.api.call('create',app.api.buildURL(this.module_name+'/license/'+this.license),{module:this.module_name},{success:function(config){if(!config.error){resolve(true);}else{resolve(false);}}.bind(this),error:function(error){reject();}.bind(this),});},updateLicense:function(){this.license=this.$('#license-key').val();this.render();var updateLicense;if(this.license.length==0){app.alert.show('message-id',{level:'confirmation',messages:'Are you sure that you want to delete License Key?',autoClose:false,onConfirm:function(){updateLicense=new Promise(this.checkLicenseActive.bind(this));updateLicense.then(function(response){if(response){this.loadData();}}.bind(this));}.bind(this),});}else{updateLicense=new Promise(this.checkLicenseActive.bind(this));updateLicense.then(function(response){if(response){this.loadData();}}.bind(this));}},checkLicenseActive:function(resolve,reject){app.api.call('create',app.api.buildURL(this.module_name+'/license'),{license:this.license,product_name:this.full_module_label,},{success:function(config){if(!config.error){resolve(true);}else{resolve(false);}}.bind(this),error:function(error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);reject();}.bind(this),});},closeConfiguration:function(){app.router.navigate('#bwc/index.php?module=Administration&action=index',{trigger:true});},render:function(){this._super('render');var loader=this.$('#loader');if(loader.html().length==0&&this.license.length>0)
loader.html('<div class="span2 offset5"><div class="loader "></div></div>');this.$('#license-frame').css('visibility','hidden').one('load',function(event){this.$('#loader').html('');this.$(event.currentTarget).css('visibility','visible');}.bind(this));},});