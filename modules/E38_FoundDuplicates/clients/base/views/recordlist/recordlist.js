({contextEvents:{'list:38elements:38elements-merge':'mergeDuplicatePair','list:38elements:ignore-duplicates':'ignoreDuplicates',},initialize:function(options){this._super('initialize',[options]);this.context.license_valid=false;this.checkLicense();if(!this.context.license_valid){return;}
this.hideIgnoredPairs();this.collection.on('data:sync:complete',function(){this.fetchRelatedDupCheckBeans().then(function(response){this.context.trigger('38elements:duplicate-check-beans-retrieved');}.bind(this)).catch(function(){app.alert.show('server-error',{level:'error',messages:app.lang.get('LBL_E38_GENERIC_ERROR'),});}.bind(this));},this);},fetchRelatedDupCheckBeans:function(){var promises=[];$.each(this.collection.models,function(index,found_duplicate_bean){var promise=new Promise(function(resolve,reject){var duplicate_check_bean_id=found_duplicate_bean.get('e38_duplicatecheck')['records'][0]['id'];var duplicate_check_bean=app.data.createBean('E38_DuplicateCheck',{id:duplicate_check_bean_id});duplicate_check_bean.fetch({success:function(duplicate_check_bean){this.collection.models[index].set('duplicate_check_bean',duplicate_check_bean);resolve(true);}.bind(this),error:function(bean,error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:app.lang.get('LBL_E38_GENERIC_ERROR'),});}
reject(false);},});}.bind(this));promises.push(promise);}.bind(this));return Promise.all(promises);},addActions:function(){this._super('addActions');this.leftColumns=[];},mergeDuplicatePair:function(found_duplicate){var for_module=found_duplicate.get('duplicate_check_bean').get('for_module');var original=app.data.createBean(for_module,{id:found_duplicate.get('duplicate_record_id_1')});var duplicate=app.data.createBean(for_module,{id:found_duplicate.get('duplicate_record_id_2')});var duplicates_collection=new Backbone.Collection();duplicates_collection.add(duplicate);duplicates_collection.add(original,{at:0,silent:true});app.drawer.open({layout:'merge-duplicates',context:{module:for_module,primaryRecord:original,selectedDuplicates:duplicates_collection.models,},},function(merge_success,merged_bean){this.collection.fetch({context:this.context,success:function(collection,b,c){this.render();}.bind(this),error:function(error){app.error.handleHttpError(error);}.bind(this),});if(typeof merge_success!='undefined'&&merge_success){var post_data={original_id:original.get('id'),duplicate_id:duplicate.get('id'),for_module:for_module,duplicate_finder_process_id:found_duplicate.get('duplicate_check_bean').get('duplicate_finder_process_id'),};app.api.call('create',app.api.buildURL('E38_MergedDuplicates/create-merged-duplicate'),post_data,{success:function(response){app.events.trigger('38elements:update-statistics-dashlet');}.bind(this),error:function(error){app.alert.show('server-error',{level:'error',messages:app.lang.get('LBL_E38_GENERIC_ERROR'),});},});}}.bind(this));},ignoreDuplicates:function(found_duplicate){app.alert.show('ignoring-pair',{level:'process'});found_duplicate.set('ignore_pair',true);found_duplicate.save(null,{success:function(){app.events.trigger('38elements:update-statistics-dashlet');this.collection.fetch({context:this.context,success:function(collection,b,c){this.render();}.bind(this),error:function(error){app.error.handleHttpError(error);}.bind(this),});}.bind(this),error:function(error){if(error.status!==412){app.alert.show('ignoring-failed',{level:'error',messages:app.lang.get('LBL_GENERIC_ERROR','E38_FoundDuplicates'),autoClose:true,});}},complete:function(){app.alert.dismissAll();},});},hideIgnoredPairs:function(){var ctx=this.options.context;var ctxCollection=ctx.get('collection');var options={showAlerts:true,apiOptions:{},};ctxCollection.filterDef=[{'ignore_pair':{$equals:0}}];ctxCollection.origFilterDef=ctxCollection.origFilterDef||[];ctx.resetLoadFlag({recursive:false});ctx.set('skipFetch',false);ctx.loadData(options);},checkLicense:function(){app.api.call('read',app.api.buildURL('E38_DeDupit/check-license'),null,{success:function(response){if(response.success){this.context.license_valid=true;}else{app.alert.show('server-error',{level:'warning',messages:app.lang.get('LBL_E38_LICENSE_INVALID'),autoClose:false,});}}.bind(this),error:function(error){if(error.status!==412){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',});}
app.error.handleHttpError(error);}.bind(this),},{async:false});},});